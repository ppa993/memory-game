<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Memory Game</title>
        <!-- Tailwind CSS for modern styling -->
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
                
                body {
                        font-family: 'Inter', sans-serif;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        position: relative;
                }

                body::before {
                        content: '';
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.03"><circle cx="30" cy="30" r="2"/></g></svg>') repeat;
                        pointer-events: none;
                        z-index: 0;
                }

                .game-board {
                        display: grid;
                        gap: 0.75rem;
                        padding: 1rem;
                        max-width: 1000px;
                        margin: 0 auto;
                        justify-content: center;
                        position: relative;
                        z-index: 1;
                        /* Grid columns will be set dynamically via JavaScript */
                }

                .card-container {
                        perspective: 1000px;
                        height: 80px;
                        width: 100%;
                        cursor: pointer;
                        position: relative;
                        aspect-ratio: 1;
                        min-height: 80px;
                        max-height: 120px;
                        transition: transform 0.2s ease;
                }

                .card-container:hover {
                        transform: translateY(-2px);
                }

                .card {
                        width: 100%;
                        height: 100%;
                        position: absolute;
                        transform-style: preserve-3d;
                        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                        border-radius: 1rem;
                        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
                        border: 2px solid rgba(255, 255, 255, 0.1);
                }

                .card:hover {
                        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.2), 0 10px 20px -8px rgba(0, 0, 0, 0.15);
                }

                .card.is-flipped {
                        transform: rotateY(180deg);
                }

                .card-face {
                        position: absolute;
                        width: 100%;
                        height: 100%;
                        backface-visibility: hidden;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 3rem;
                        font-weight: 700;
                        border-radius: 1rem;
                        padding: 0.5rem;
                        user-select: none;
                        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                }

                .card-face.front {
                        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
                        color: #2d3748;
                        transform: rotateY(180deg);
                        border: 2px solid rgba(255, 255, 255, 0.2);
                }

                .card-face.back {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: #ffffff;
                        font-size: 3rem;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        border: 2px solid rgba(255, 255, 255, 0.2);
                }

                .card-container:hover .card-face.back {
                        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
                }

                /* --- Styling for matched cards --- */
                .card.is-matched {
                        pointer-events: none;
                        /* Disable clicks on matched cards */
                        animation: matchPulse 0.6s ease-out;
                }

                .card.is-matched .card-face.front {
                        border: 3px solid #10b981;
                        box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
                        /* Add a green border for emphasis */
                }

                @keyframes matchPulse {
                        0% { transform: rotateY(180deg) scale(1); }
                        50% { transform: rotateY(180deg) scale(1.05); }
                        100% { transform: rotateY(180deg) scale(1); }
                }

                @keyframes slideInUp {
                        from {
                                opacity: 0;
                                transform: translateY(30px);
                        }
                        to {
                                opacity: 1;
                                transform: translateY(0);
                        }
                }

                .card-container {
                        animation: slideInUp 0.5s ease-out;
                        animation-fill-mode: both;
                }

                .card-container:nth-child(1) { animation-delay: 0.1s; }
                .card-container:nth-child(2) { animation-delay: 0.15s; }
                .card-container:nth-child(3) { animation-delay: 0.2s; }
                .card-container:nth-child(4) { animation-delay: 0.25s; }
                .card-container:nth-child(5) { animation-delay: 0.3s; }
                .card-container:nth-child(6) { animation-delay: 0.35s; }
                .card-container:nth-child(7) { animation-delay: 0.4s; }
                .card-container:nth-child(8) { animation-delay: 0.45s; }
                .card-container:nth-child(9) { animation-delay: 0.5s; }
                .card-container:nth-child(10) { animation-delay: 0.55s; }

                /* Styles for the multiple selection */
                .selection-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 0.5rem;
                }

                .selection-label {
                        display: flex;
                        align-items: center;
                        padding: 0.75rem;
                        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                        border-radius: 0.75rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: 2px solid transparent;
                        position: relative;
                        overflow: hidden;
                }

                .selection-label::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
                        transition: left 0.5s ease;
                }

                .selection-label:hover {
                        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                        border-color: #667eea;
                }

                .selection-label:hover::before {
                        left: 100%;
                }

                .selection-label input[type="checkbox"]:checked + span {
                        color: #667eea;
                        font-weight: 600;
                }

                .selection-label input[type="checkbox"] {
                        margin-right: 0.5rem;
                        transform: scale(1.2);
                        accent-color: #667eea;
                }

                @media (min-width: 640px) {
                        .selection-grid {
                                grid-template-columns: repeat(3, 1fr);
                        }
                }

                @media (min-width: 768px) {
                        .selection-grid {
                                grid-template-columns: repeat(4, 1fr);
                        }
                }

                @media (min-width: 1024px) {
                        .selection-grid {
                                grid-template-columns: repeat(5, 1fr);
                        }
                }


                @media (max-width: 768px) {
                        .card-face {
                                font-size: 2.5rem;
                        }

                        .card-face.back {
                                font-size: 2.5rem;
                        }
                }

                @media (max-width: 480px) {
                        .card-face {
                                font-size: 1.5rem;
                        }

                        .card-face.back {
                                font-size: 1.5rem;
                        }
                }
        </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen p-4 relative">

        <div class="bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-8 max-w-4xl w-full border border-white/20 relative z-10">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                        <h1 class="text-4xl sm:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600 text-center sm:text-left w-full mb-4 sm:mb-0"
                                id="game-title">Hiragana Memory Game</h1>
                        <div class="flex items-center space-x-4">
                                <div class="text-2xl sm:text-3xl font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-xl border-2 border-gray-200" id="timer">00:00</div>
                                <div class="hidden" id="progress-container">
                                        <div class="text-sm text-gray-600 mb-1">Progress</div>
                                        <div class="w-24 h-3 bg-gray-200 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r from-green-400 to-blue-500 rounded-full transition-all duration-500 ease-out" id="progress-bar" style="width: 0%"></div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1" id="progress-text">0/0</div>
                                </div>
                        </div>
                </div>
                <p class="text-center text-gray-600 mb-6 text-lg" id="game-instruction">Ghép các cặp ký tự Hiragana và Romanji
                        tương ứng!</p>

                <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-2xl mb-6 border-2 border-gray-200/50">
                        <h3 class="text-lg font-bold mb-3 text-gray-800">Chọn chế độ:</h3>
                        <div class="flex space-x-4 mb-6">
                                <label class="flex items-center bg-white p-3 rounded-xl cursor-pointer transition-all hover:shadow-md border-2 border-transparent hover:border-purple-200">
                                        <input type="radio" name="script-mode" value="hiragana" checked
                                                class="form-radio text-purple-600 scale-125">
                                        <span class="ml-3 font-semibold text-gray-700">Hiragana</span>
                                </label>
                                <label class="flex items-center bg-white p-3 rounded-xl cursor-pointer transition-all hover:shadow-md border-2 border-transparent hover:border-purple-200">
                                        <input type="radio" name="script-mode" value="katakana"
                                                class="form-radio text-purple-600 scale-125">
                                        <span class="ml-3 font-semibold text-gray-700">Katakana</span>
                                </label>
                        </div>

                        <h3 class="text-lg font-bold mb-3 text-gray-800">Chọn nhóm ký tự:</h3>
                        <div id="selection-options" class="selection-grid">
                                <!-- Checkboxes will be dynamically added here -->
                        </div>
                </div>

                <div class="flex justify-center mb-6">
                        <button id="start-game-button"
                                class="px-8 py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300 relative overflow-hidden">
                                <span class="relative z-10">Bắt đầu trò chơi</span>
                                <div class="absolute inset-0 bg-gradient-to-r from-purple-700 to-blue-700 opacity-0 hover:opacity-100 transition-opacity duration-300"></div>
                        </button>
                </div>

                <div class="message-box bg-gradient-to-r from-blue-50 to-purple-50 text-blue-800 p-4 rounded-2xl text-center font-semibold mb-6 hidden border-2 border-blue-200/50"
                        id="message-box">
                        Nhấp vào một thẻ để bắt đầu.
                </div>

                <div class="game-board" id="game-board">
                        <!-- Cards will be dynamically inserted here by JavaScript -->
                </div>

                <div class="flex justify-center mt-6">
                        <button id="restart-button"
                                class="px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 hidden relative overflow-hidden">
                                <span class="relative z-10">Chơi lại</span>
                                <div class="absolute inset-0 bg-gradient-to-r from-green-600 to-emerald-700 opacity-0 hover:opacity-100 transition-opacity duration-300"></div>
                        </button>
                </div>
        </div>

        <script>
                document.addEventListener('DOMContentLoaded', () => {
                        // Game variables and state
                        const gameBoard = document.getElementById('game-board');
                        const messageBox = document.getElementById('message-box');
                        const startButton = document.getElementById('start-game-button');
                        const restartButton = document.getElementById('restart-button');
                        const timerDisplay = document.getElementById('timer');
                        const selectionOptionsContainer = document.getElementById('selection-options');
                        const scriptModeRadios = document.querySelectorAll('input[name="script-mode"]');
                        const gameTitleElement = document.getElementById('game-title');
                        const gameInstructionElement = document.getElementById('game-instruction');
                        const progressContainer = document.getElementById('progress-container');
                        const progressBar = document.getElementById('progress-bar');
                        const progressText = document.getElementById('progress-text');

                        let cards = [];
                        let hasFlippedCard = false;
                        let lockBoard = false;
                        let firstCard, secondCard;
                        let matchedPairs = 0;
                        let pairsPerGame = 0;
                        let timer = null;
                        let seconds = 0;
                        let minutes = 0;

                        // --- Hiragana and Katakana Data ---
                        const allHiraganaPairs = [
                                { id: 1, value: 'あ', romanji: 'a', group: 'vowels', groupName: 'Nguyên âm' },
                                { id: 2, value: 'い', romanji: 'i', group: 'vowels', groupName: 'Nguyên âm' },
                                { id: 3, value: 'う', romanji: 'u', group: 'vowels', groupName: 'Nguyên âm' },
                                { id: 4, value: 'え', romanji: 'e', group: 'vowels', groupName: 'Nguyên âm' },
                                { id: 5, value: 'お', romanji: 'o', group: 'vowels', groupName: 'Nguyên âm' },
                                { id: 6, value: 'か', romanji: 'ka', group: 'k-group', groupName: 'Hàng K' },
                                { id: 7, value: 'き', romanji: 'ki', group: 'k-group', groupName: 'Hàng K' },
                                { id: 8, value: 'く', romanji: 'ku', group: 'k-group', groupName: 'Hàng K' },
                                { id: 9, value: 'け', romanji: 'ke', group: 'k-group', groupName: 'Hàng K' },
                                { id: 10, value: 'こ', romanji: 'ko', group: 'k-group', groupName: 'Hàng K' },
                                { id: 11, value: 'さ', romanji: 'sa', group: 's-group', groupName: 'Hàng S' },
                                { id: 12, value: 'し', romanji: 'shi', group: 's-group', groupName: 'Hàng S' },
                                { id: 13, value: 'す', romanji: 'su', group: 's-group', groupName: 'Hàng S' },
                                { id: 14, value: 'せ', romanji: 'se', group: 's-group', groupName: 'Hàng S' },
                                { id: 15, value: 'そ', romanji: 'so', group: 's-group', groupName: 'Hàng S' },
                                { id: 16, value: 'た', romanji: 'ta', group: 't-group', groupName: 'Hàng T' },
                                { id: 17, value: 'ち', romanji: 'chi', group: 't-group', groupName: 'Hàng T' },
                                { id: 18, value: 'つ', romanji: 'tsu', group: 't-group', groupName: 'Hàng T' },
                                { id: 19, value: 'て', romanji: 'te', group: 't-group', groupName: 'Hàng T' },
                                { id: 20, value: 'と', romanji: 'to', group: 't-group', groupName: 'Hàng T' },
                                { id: 21, value: 'な', romanji: 'na', group: 'n-group', groupName: 'Hàng N' },
                                { id: 22, value: 'に', romanji: 'ni', group: 'n-group', groupName: 'Hàng N' },
                                { id: 23, value: 'ぬ', romanji: 'nu', group: 'n-group', groupName: 'Hàng N' },
                                { id: 24, value: 'ね', romanji: 'ne', group: 'n-group', groupName: 'Hàng N' },
                                { id: 25, value: 'の', romanji: 'no', group: 'n-group', groupName: 'Hàng N' },
                                { id: 26, value: 'は', romanji: 'ha', group: 'h-group', groupName: 'Hàng H' },
                                { id: 27, value: 'ひ', romanji: 'hi', group: 'h-group', groupName: 'Hàng H' },
                                { id: 28, value: 'ふ', romanji: 'fu', group: 'h-group', groupName: 'Hàng H' },
                                { id: 29, value: 'へ', romanji: 'he', group: 'h-group', groupName: 'Hàng H' },
                                { id: 30, value: 'ほ', romanji: 'ho', group: 'h-group', groupName: 'Hàng H' },
                                { id: 31, value: 'ま', romanji: 'ma', group: 'm-group', groupName: 'Hàng M' },
                                { id: 32, value: 'み', romanji: 'mi', group: 'm-group', groupName: 'Hàng M' },
                                { id: 33, value: 'む', romanji: 'mu', group: 'm-group', groupName: 'Hàng M' },
                                { id: 34, value: 'め', romanji: 'me', group: 'm-group', groupName: 'Hàng M' },
                                { id: 35, value: 'も', romanji: 'mo', group: 'm-group', groupName: 'Hàng M' },
                                { id: 36, value: 'や', romanji: 'ya', group: 'y-group', groupName: 'Hàng Y' },
                                { id: 37, value: 'ゆ', romanji: 'yu', group: 'y-group', groupName: 'Hàng Y' },
                                { id: 38, value: 'よ', romanji: 'yo', group: 'y-group', groupName: 'Hàng Y' },
                                { id: 39, value: 'ら', romanji: 'ra', group: 'r-group', groupName: 'Hàng R' },
                                { id: 40, value: 'り', romanji: 'ri', group: 'r-group', groupName: 'Hàng R' },
                                { id: 41, value: 'る', romanji: 'ru', group: 'r-group', groupName: 'Hàng R' },
                                { id: 42, value: 'れ', romanji: 're', group: 'r-group', groupName: 'Hàng R' },
                                { id: 43, value: 'ろ', romanji: 'ro', group: 'r-group', groupName: 'Hàng R' },
                                { id: 44, value: 'わ', romanji: 'wa', group: 'w-group', groupName: 'Hàng W' },
                                { id: 45, value: 'を', romanji: 'wo', group: 'w-group', groupName: 'Hàng W' },
                                { id: 46, value: 'ん', romanji: 'n', group: 'w-group', groupName: 'Hàng W' },
                        ];

                        const allKatakanaPairs = [
                                { id: 101, value: 'ア', romanji: 'a', group: 'vowels', groupName: 'Nguyên âm' },
                                { id: 102, value: 'イ', romanji: 'i', group: 'vowels', groupName: 'Nguyên âm' },
                                { id: 103, value: 'ウ', romanji: 'u', group: 'vowels', groupName: 'Nguyên âm' },
                                { id: 104, value: 'エ', romanji: 'e', group: 'vowels', groupName: 'Nguyên âm' },
                                { id: 105, value: 'オ', romanji: 'o', group: 'vowels', groupName: 'Nguyên âm' },
                                { id: 106, value: 'カ', romanji: 'ka', group: 'k-group', groupName: 'Hàng K' },
                                { id: 107, value: 'キ', romanji: 'ki', group: 'k-group', groupName: 'Hàng K' },
                                { id: 108, value: 'ク', romanji: 'ku', group: 'k-group', groupName: 'Hàng K' },
                                { id: 109, value: 'ケ', romanji: 'ke', group: 'k-group', groupName: 'Hàng K' },
                                { id: 110, value: 'コ', romanji: 'ko', group: 'k-group', groupName: 'Hàng K' },
                                { id: 111, value: 'サ', romanji: 'sa', group: 's-group', groupName: 'Hàng S' },
                                { id: 112, value: 'シ', romanji: 'shi', group: 's-group', groupName: 'Hàng S' },
                                { id: 113, value: 'ス', romanji: 'su', group: 's-group', groupName: 'Hàng S' },
                                { id: 114, value: 'セ', romanji: 'se', group: 's-group', groupName: 'Hàng S' },
                                { id: 115, value: 'ソ', romanji: 'so', group: 's-group', groupName: 'Hàng S' },
                                { id: 116, value: 'タ', romanji: 'ta', group: 't-group', groupName: 'Hàng T' },
                                { id: 117, value: 'チ', romanji: 'chi', group: 't-group', groupName: 'Hàng T' },
                                { id: 118, value: 'ツ', romanji: 'tsu', group: 't-group', groupName: 'Hàng T' },
                                { id: 119, value: 'テ', romanji: 'te', group: 't-group', groupName: 'Hàng T' },
                                { id: 120, value: 'ト', romanji: 'to', group: 't-group', groupName: 'Hàng T' },
                                { id: 121, value: 'ナ', romanji: 'na', group: 'n-group', groupName: 'Hàng N' },
                                { id: 122, value: 'ニ', romanji: 'ni', group: 'n-group', groupName: 'Hàng N' },
                                { id: 123, value: 'ヌ', romanji: 'nu', group: 'n-group', groupName: 'Hàng N' },
                                { id: 124, value: 'ネ', romanji: 'ne', group: 'n-group', groupName: 'Hàng N' },
                                { id: 125, value: 'ノ', romanji: 'no', group: 'n-group', groupName: 'Hàng N' },
                                { id: 126, value: 'ハ', romanji: 'ha', group: 'h-group', groupName: 'Hàng H' },
                                { id: 127, value: 'ヒ', romanji: 'hi', group: 'h-group', groupName: 'Hàng H' },
                                { id: 128, value: 'フ', romanji: 'fu', group: 'h-group', groupName: 'Hàng H' },
                                { id: 129, value: 'ヘ', romanji: 'he', group: 'h-group', groupName: 'Hàng H' },
                                { id: 130, value: 'ホ', romanji: 'ho', group: 'h-group', groupName: 'Hàng H' },
                                { id: 131, value: 'マ', romanji: 'ma', group: 'm-group', groupName: 'Hàng M' },
                                { id: 132, value: 'ミ', romanji: 'mi', group: 'm-group', groupName: 'Hàng M' },
                                { id: 133, value: 'ム', romanji: 'mu', group: 'm-group', groupName: 'Hàng M' },
                                { id: 134, value: 'メ', romanji: 'me', group: 'm-group', groupName: 'Hàng M' },
                                { id: 135, value: 'モ', romanji: 'mo', group: 'm-group', groupName: 'Hàng M' },
                                { id: 136, value: 'ヤ', romanji: 'ya', group: 'y-group', groupName: 'Hàng Y' },
                                { id: 137, value: 'ユ', romanji: 'yu', group: 'y-group', groupName: 'Hàng Y' },
                                { id: 138, value: 'ヨ', romanji: 'yo', group: 'y-group', groupName: 'Hàng Y' },
                                { id: 139, value: 'ラ', romanji: 'ra', group: 'r-group', groupName: 'Hàng R' },
                                { id: 140, value: 'リ', romanji: 'ri', group: 'r-group', groupName: 'Hàng R' },
                                { id: 141, value: 'ル', romanji: 'ru', group: 'r-group', groupName: 'Hàng R' },
                                { id: 142, value: 'レ', romanji: 're', group: 'r-group', groupName: 'Hàng R' },
                                { id: 143, value: 'ロ', romanji: 'ro', group: 'r-group', groupName: 'Hàng R' },
                                { id: 144, value: 'ワ', romanji: 'wa', group: 'w-group', groupName: 'Hàng W' },
                                { id: 145, value: 'ヲ', romanji: 'wo', group: 'w-group', groupName: 'Hàng W' },
                                { id: 46, value: 'ン', romanji: 'n', group: 'w-group', groupName: 'Hàng W' },
                        ];

                        // Mapping for selection options
                        const selectionGroups = [
                                { id: 'all', name: 'Tất cả' },
                                { id: 'vowels', name: 'Nguyên âm' },
                                { id: 'k-group', name: 'Hàng K' },
                                { id: 's-group', name: 'Hàng S' },
                                { id: 't-group', name: 'Hàng T' },
                                { id: 'n-group', name: 'Hàng N' },
                                { id: 'h-group', name: 'Hàng H' },
                                { id: 'm-group', name: 'Hàng M' },
                                { id: 'y-group', name: 'Hàng Y' },
                                { id: 'r-group', name: 'Hàng R' },
                                { id: 'w-group', name: 'Hàng W' },
                        ];

                        // Function to update progress bar
                        function updateProgress() {
                                const progress = (matchedPairs / pairsPerGame) * 100;
                                progressBar.style.width = `${progress}%`;
                                progressText.textContent = `${matchedPairs}/${pairsPerGame}`;
                        }
                        function calculateOptimalGrid(cardCount) {
                                // Handle special cases for better aesthetics
                                const gridOptions = {
                                        4: { cols: 2, rows: 2 },
                                        6: { cols: 3, rows: 2 },
                                        8: { cols: 4, rows: 2 },
                                        9: { cols: 3, rows: 3 },
                                        10: { cols: 5, rows: 2 },
                                        12: { cols: 4, rows: 3 },
                                        14: { cols: 7, rows: 2 },
                                        15: { cols: 5, rows: 3 },
                                        16: { cols: 4, rows: 4 },
                                        18: { cols: 6, rows: 3 },
                                        20: { cols: 5, rows: 4 },
                                        22: { cols: 7, rows: 4 }, // Wide layout for 22
                                        24: { cols: 6, rows: 4 },
                                        25: { cols: 5, rows: 5 },
                                        30: { cols: 6, rows: 5 },
                                        32: { cols: 8, rows: 4 },
                                        36: { cols: 6, rows: 6 },
                                        40: { cols: 8, rows: 5 }
                                };

                                // If we have a predefined optimal layout, use it
                                if (gridOptions[cardCount]) {
                                        return gridOptions[cardCount];
                                }

                                // For other numbers, calculate the best rectangular layout
                                let bestCols = Math.ceil(Math.sqrt(cardCount));
                                let bestRows = Math.ceil(cardCount / bestCols);

                                // Try to find a more rectangular layout if it's better
                                for (let cols = 2; cols <= cardCount; cols++) {
                                        const rows = Math.ceil(cardCount / cols);
                                        const totalCells = cols * rows;
                                        const currentBest = bestCols * bestRows;

                                        // Prefer layouts with fewer empty cells and better aspect ratio
                                        if (totalCells < currentBest ||
                                            (totalCells === currentBest && Math.abs(cols - rows) < Math.abs(bestCols - bestRows))) {
                                                bestCols = cols;
                                                bestRows = rows;
                                        }
                                }

                                return { cols: bestCols, rows: bestRows };
                        }

                        // Function to apply dynamic grid layout
                        function setDynamicGrid(cardCount) {
                                const { cols, rows } = calculateOptimalGrid(cardCount);
                                const gameBoard = document.getElementById('game-board');

                                // Set grid template columns
                                gameBoard.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

                                // Adjust gap and max-width based on column count
                                if (cols <= 4) {
                                        gameBoard.style.gap = '1rem';
                                        gameBoard.style.maxWidth = '600px';
                                } else if (cols <= 6) {
                                        gameBoard.style.gap = '0.75rem';
                                        gameBoard.style.maxWidth = '800px';
                                } else {
                                        gameBoard.style.gap = '0.5rem';
                                        gameBoard.style.maxWidth = '1000px';
                                }

                                // Adjust on mobile devices
                                if (window.innerWidth <= 480 && cols > 4) {
                                        // Force smaller grid on mobile for readability
                                        const mobileCols = Math.min(4, cols);
                                        gameBoard.style.gridTemplateColumns = `repeat(${mobileCols}, 1fr)`;
                                        gameBoard.style.gap = '0.5rem';
                                        gameBoard.style.maxWidth = '100%';
                                }
                        }

                        // Function to start the timer
                        function startTimer() {
                                if (timer) return; // Prevent multiple timers from running
                                timer = setInterval(() => {
                                        seconds++;
                                        if (seconds === 60) {
                                                seconds = 0;
                                                minutes++;
                                        }
                                        const formattedMinutes = String(minutes).padStart(2, '0');
                                        const formattedSeconds = String(seconds).padStart(2, '0');
                                        timerDisplay.textContent = `${formattedMinutes}:${formattedSeconds}`;
                                }, 1000);
                        }

                        // Function to stop the timer
                        function stopTimer() {
                                clearInterval(timer);
                                timer = null;
                        }

                        // Render selection options based on the selected script mode
                        function renderSelectionOptions() {
                                selectionOptionsContainer.innerHTML = '';
                                selectionGroups.forEach(group => {
                                        const label = document.createElement('label');
                                        label.classList.add('selection-label');
                                        const checkbox = document.createElement('input');
                                        checkbox.type = 'checkbox';
                                        checkbox.value = group.id;
                                        checkbox.name = 'kana-group';
                                        if (group.id === 'vowels') {
                                                checkbox.checked = true; // Select a default group
                                        }
                                        const span = document.createElement('span');
                                        span.textContent = group.name;

                                        label.appendChild(checkbox);
                                        label.appendChild(span);
                                        selectionOptionsContainer.appendChild(label);
                                });

                                // Add event listener for the "Tất cả" checkbox
                                const allCheckbox = document.querySelector('input[value="all"]');
                                const otherCheckboxes = document.querySelectorAll('input[name="kana-group"]:not([value="all"])');

                                if (allCheckbox) {
                                        allCheckbox.addEventListener('change', (event) => {
                                                const isChecked = event.target.checked;
                                                otherCheckboxes.forEach(cb => {
                                                        cb.checked = isChecked;
                                                });
                                        });
                                }

                                // Add event listener to other checkboxes to manage the "Tất cả" state
                                otherCheckboxes.forEach(cb => {
                                        cb.addEventListener('change', () => {
                                                const allOthersChecked = Array.from(otherCheckboxes).every(c => c.checked);
                                                if (allCheckbox) {
                                                        allCheckbox.checked = allOthersChecked;
                                                }
                                        });
                                });
                        }

                        // Function to handle script mode change (Hiragana/Katakana)
                        function handleScriptModeChange() {
                                const selectedMode = document.querySelector('input[name="script-mode"]:checked').value;

                                if (selectedMode === 'hiragana') {
                                        gameTitleElement.textContent = 'Hiragana Memory Game';
                                        document.title = 'Hiragana Memory Game';
                                        gameInstructionElement.textContent = 'Ghép các cặp ký tự Hiragana và Romanji tương ứng!';
                                } else {
                                        gameTitleElement.textContent = 'Katakana Memory Game';
                                        document.title = 'Katakana Memory Game';
                                        gameInstructionElement.textContent = 'Ghép các cặp ký tự Katakana và Romanji tương ứng!';
                                }
                                // Re-render selection options in case we want different groups for each script in the future
                                renderSelectionOptions();
                        }

                        // Initialize the game board
                        function initializeBoard() {
                                // Hide selection options and show game UI
                                selectionOptionsContainer.parentElement.classList.add('hidden');
                                document.querySelector('.bg-gradient-to-r.from-gray-50').classList.add('hidden'); // Hide the script mode selection
                                startButton.classList.add('hidden');
                                messageBox.classList.remove('hidden');
                                restartButton.classList.remove('hidden');
                                progressContainer.classList.remove('hidden');

                                // Stop and reset timer
                                stopTimer();
                                seconds = 0;
                                minutes = 0;
                                timerDisplay.textContent = '00:00';

                                // Get the selected script mode and corresponding data
                                const selectedMode = document.querySelector('input[name="script-mode"]:checked').value;
                                const selectedPairsData = selectedMode === 'hiragana' ? allHiraganaPairs : allKatakanaPairs;

                                // Get selected ranges and filter pairs
                                const selectedCheckboxes = document.querySelectorAll('input[name="kana-group"]:checked');
                                let selectedGroups = Array.from(selectedCheckboxes).map(cb => cb.value);

                                // Filter out the 'all' option from the selected groups
                                const nonAllSelectedGroups = selectedGroups.filter(g => g !== 'all');

                                // If 'all' is selected, use all groups. Otherwise, use the selected ones.
                                const groupsToUse = selectedGroups.includes('all') || nonAllSelectedGroups.length === 0 ?
                                        selectionGroups.filter(g => g.id !== 'all').map(g => g.id) :
                                        nonAllSelectedGroups;

                                // Filter the main array based on the selected group IDs
                                let pairsToUse = selectedPairsData.filter(pair => groupsToUse.includes(pair.group));

                                // Shuffle and select pairs if there are too many for the board
                                if (pairsToUse.length > 20) { // Limit to 20 pairs for a reasonable board size
                                        pairsToUse = pairsToUse.sort(() => Math.random() - 0.5).slice(0, 20);
                                }

                                pairsPerGame = pairsToUse.length;
                                if (pairsPerGame === 0) {
                                        messageBox.textContent = 'Vui lòng chọn ít nhất một nhóm ký tự để bắt đầu!';
                                        return;
                                }

                                // Combine hiragana and romanji into a single array for the game board
                                const gameContent = pairsToUse.flatMap(pair => [
                                        { pairId: pair.id, type: 'kana', value: pair.value },
                                        { pairId: pair.id, type: 'romanji', value: pair.romanji }
                                ]);

                                // Shuffle the cards again
                                gameContent.sort(() => Math.random() - 0.5);

                                // Set dynamic grid layout based on card count
                                setDynamicGrid(gameContent.length);

                                // Clear the existing board
                                gameBoard.innerHTML = '';

                                // Create and append the card elements to the board
                                gameContent.forEach(cardData => {
                                        const cardContainer = document.createElement('div');
                                        cardContainer.classList.add('card-container');
                                        cardContainer.dataset.pairId = cardData.pairId;
                                        cardContainer.dataset.value = cardData.value;
                                        cardContainer.dataset.type = cardData.type;

                                        const cardElement = document.createElement('div');
                                        cardElement.classList.add('card');

                                        const cardFront = document.createElement('div');
                                        cardFront.classList.add('card-face', 'front');
                                        cardFront.textContent = cardData.value;

                                        const cardBack = document.createElement('div');
                                        cardBack.classList.add('card-face', 'back');
                                        cardBack.textContent = '?';

                                        cardElement.appendChild(cardFront);
                                        cardElement.appendChild(cardBack);
                                        cardContainer.appendChild(cardElement);
                                        gameBoard.appendChild(cardContainer);
                                });

                                // Attach event listeners to the cards
                                cards = document.querySelectorAll('.card-container');
                                cards.forEach(card => card.addEventListener('click', flipCard));
                                messageBox.textContent = 'Nhấp vào một thẻ để bắt đầu.';

                                // Reset game state
                                matchedPairs = 0;
                                updateProgress();
                                resetBoard();
                        }

                        // Function to handle a card click
                        function flipCard() {
                                // If the board is locked or the same card is clicked, do nothing
                                if (lockBoard) return;
                                if (this === firstCard) return;

                                // Start the timer on the first card flip
                                if (!hasFlippedCard && !timer) {
                                        startTimer();
                                }

                                // Get the card element and flip it
                                const cardElement = this.querySelector('.card');
                                cardElement.classList.add('is-flipped');

                                if (!hasFlippedCard) {
                                        // First card clicked
                                        hasFlippedCard = true;
                                        firstCard = this;
                                        return;
                                }

                                // Second card clicked
                                secondCard = this;
                                lockBoard = true;

                                // Check for a match
                                checkForMatch();
                        }

                        // Function to check if the two flipped cards are a match
                        function checkForMatch() {
                                const isMatch = firstCard.dataset.pairId === secondCard.dataset.pairId;

                                if (isMatch) {
                                        disableCards();
                                } else {
                                        unflipCards();
                                }
                        }

                        // Cards match, keep them flipped
                        function disableCards() {
                                // Add a small delay to let the second card flip animation complete
                                setTimeout(() => {
                                        // Add the 'is-matched' class to the card elements to indicate a permanent match
                                        firstCard.querySelector('.card').classList.add('is-matched');
                                        secondCard.querySelector('.card').classList.add('is-matched');

                                        // Remove the event listeners to prevent further clicks on these cards
                                        firstCard.removeEventListener('click', flipCard);
                                        secondCard.removeEventListener('click', flipCard);

                                        // Increment matched pairs and check for a win
                                        matchedPairs++;
                                        updateProgress();
                                        if (matchedPairs === pairsPerGame) {
                                                stopTimer();
                                                const finalTime = timerDisplay.textContent;
                                                messageBox.innerHTML = `<div class="text-2xl">🎉</div><div>Chúc mừng, bạn đã chiến thắng trong ${finalTime}!</div>`;
                                                messageBox.classList.add('animate-pulse');
                                                restartButton.textContent = 'Chơi lại?';
                                        } else {
                                                messageBox.textContent = 'Tuyệt vời! Tìm cặp tiếp theo.';
                                        }
                                        resetBoard();
                                }, 600); // Wait for the flip animation to complete (card flip is 0.6s)
                        }

                        // Cards do not match, unflip them after a delay
                        function unflipCards() {
                                lockBoard = true;
                                messageBox.textContent = 'Không khớp, hãy thử lại.';

                                setTimeout(() => {
                                        firstCard.querySelector('.card').classList.remove('is-flipped');
                                        secondCard.querySelector('.card').classList.remove('is-flipped');
                                        resetBoard();
                                }, 1500); // Wait for 1.5 seconds before flipping back
                        }

                        // Reset the card state for the next turn
                        function resetBoard() {
                                [hasFlippedCard, lockBoard] = [false, false];
                                [firstCard, secondCard] = [null, null];
                        }

                        // Event listener for the restart button and start button
                        startButton.addEventListener('click', initializeBoard);
                        restartButton.addEventListener('click', () => {
                                location.reload(); // Reload the page to reset everything
                        });

                        // Listen for changes in the script mode radio buttons
                        scriptModeRadios.forEach(radio => {
                                radio.addEventListener('change', handleScriptModeChange);
                        });

                        // Handle window resize for responsive grid
                        window.addEventListener('resize', () => {
                                const cards = document.querySelectorAll('.card-container');
                                if (cards.length > 0) {
                                        setDynamicGrid(cards.length);
                                }
                        });

                        // Initial setup
                        handleScriptModeChange();
                });
        </script>
</body>

</html>
